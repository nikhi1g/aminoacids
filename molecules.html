<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Biochemistry - Flashcards</title>
    <link rel="preconnect" href="https://api.github.com" crossorigin>
    <link rel="dns-prefetch" href="https://api.github.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script>
        // Apply theme immediately to prevent flash
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <script src="https://unpkg.com/jsme-editor@latest/jsme.nocache.js"></script>
    <script type="module" src="ocl-loader.js"></script>
    <script src="https://unpkg.com/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 flex flex-col min-h-screen">

    <header class="bg-white dark:bg-slate-900 border-b dark:border-slate-800 sticky top-0 z-20 shadow-sm transition-colors transition-transform duration-300">

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col space-y-2 sm:space-y-4 py-2 sm:py-4">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 sm:gap-0 sm:h-16">
                    <div class="flex items-center justify-center sm:justify-start w-full sm:w-auto">
                        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50/80 dark:bg-slate-900/50 px-2 py-1.5 sm:px-3 sm:py-2 text-center sm:text-left">
                            <div class="text-[10px] sm:text-xs font-bold uppercase tracking-widest text-slate-800 dark:text-slate-100 text-center sm:text-left">mcat</div>
                            <div class="mt-0.5 sm:mt-1 flex flex-wrap items-center gap-2 text-[9px] sm:text-[10px] text-slate-500 justify-center sm:justify-start">
                                <span id="commit-hash">loading...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center justify-center sm:justify-end gap-3 sm:gap-6 w-full sm:w-auto">
                        <nav class="flex flex-wrap justify-center sm:justify-start gap-3 sm:gap-8" aria-label="Biochemistry">
                            <a href="index.html" class="nav-link py-2 sm:py-5 text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" title="Home">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                            </a>
                            <a href="153b.html" class="nav-link py-2 sm:py-5 text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">Flashcards</a>
                        </nav>

                        <button onclick="toggleDarkMode()" class="p-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors shrink-0" title="Toggle Dark/Light Mode">
                            <svg id="sun-icon" class="hidden dark:block w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"></path>
                            </svg>
                            <svg id="moon-icon" class="block dark:hidden w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-center sm:justify-start">
                    <a href="index.html" class="inline-flex items-center justify-center w-9 h-9 rounded-full border border-slate-200 bg-white text-slate-500 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-300 dark:hover:bg-slate-800 transition-colors" aria-label="Home" title="Home">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow w-full px-4 sm:px-6 lg:px-8 py-6 flex flex-col">
        <section class="max-w-7xl mx-auto w-full flex flex-col">
            <!-- Set Navigation Tabs -->
            <div class="flex items-center gap-1 mb-6 border-b dark:border-slate-800">
                <button id="tab-midterm1" class="set-tab px-4 py-2 text-sm font-bold border-b-2 transition-all" data-set="midterm1">Midterm 1</button>
                <button id="tab-chapter1" class="set-tab px-4 py-2 text-sm font-bold border-b-2 transition-all" data-set="chapter1">Chapter 1</button>
                <button id="tab-molecules" class="set-tab px-4 py-2 text-sm font-bold border-b-2 transition-all" data-set="molecules">Molecules</button>
            </div>

            <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 mb-6">
                <div class="flex-grow">
                    <p class="text-xs uppercase tracking-[0.35em] text-slate-400 font-semibold">BioBioChem</p>
                    <h1 id="main-title" class="text-3xl sm:text-4xl font-black text-slate-900 dark:text-white">Molecules</h1>
                </div>
                <div class="flex flex-wrap items-center justify-center sm:justify-end gap-3">
                    <div class="inline-flex items-center rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 p-1">
                        <button id="sub-show-btn" class="sub-btn px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-widest transition-colors bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900">Show</button>
                        <button id="sub-draw-btn" class="sub-btn px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-widest transition-colors text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200">Draw</button>
                    </div>
                </div>
            </div>

            <!-- SHOW SECTION -->
            <div id="section-show" class="w-full">
                <div id="molecule-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Molecule Cards injected here -->
                </div>
            </div>

            <!-- DRAW SECTION -->
            <div id="section-draw" class="hidden w-full max-w-6xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                    <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-lg p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold">Draw</h2>
                            <div class="flex gap-2">
                                <button id="draw-clear-btn" class="px-3 py-1.5 rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50 text-xs font-bold">Clear</button>
                                <button id="draw-next-btn" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white hover:bg-slate-800 text-xs font-bold">Next</button>
                            </div>
                        </div>
                        <div id="jsme-container" class="jsme-container w-full h-[400px]"></div>
                        <div class="mt-4">
                            <button id="draw-check-btn" class="w-full py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold transition-colors">Check Answer</button>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-lg p-6 space-y-6">
                        <div>
                            <p class="text-xs uppercase tracking-widest text-slate-400">Target</p>
                            <h3 id="draw-target-name" class="text-3xl font-black text-slate-800 dark:text-white mt-1">Select a Molecule</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div id="draw-user-wrapper" class="hidden bg-slate-50/60 dark:bg-slate-800/30 rounded-xl border border-slate-100 dark:border-slate-800 p-4">
                                <p class="text-xs uppercase tracking-widest text-slate-400 mb-2">You Drew</p>
                                <div class="flex items-center justify-center min-h-[180px]">
                                    <canvas id="draw-user-canvas" class="w-full h-full"></canvas>
                                </div>
                            </div>
                            <div id="draw-expected-wrapper" class="hidden bg-slate-50/60 dark:bg-slate-800/30 rounded-xl border border-slate-100 dark:border-slate-800 p-4">
                                <p class="text-xs uppercase tracking-widest text-slate-400 mb-2">Expected</p>
                                <div class="flex items-center justify-center min-h-[180px]">
                                    <canvas id="draw-expected-canvas" class="w-full h-full"></canvas>
                                </div>
                            </div>
                        </div>

                        <div id="draw-feedback" class="text-lg font-bold text-slate-600"></div>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <footer class="mt-12 bg-white dark:bg-slate-900 border-t dark:border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4"></div>
    </footer>

    <script src="script.js"></script>
    <script src="molecules-data.js"></script>
    <script>
        let currentSet = 'molecules';
        let currentSub = 'show';
        let jsmeApplet = null;
        let drawTarget = null;
        let chemistryReady = false;

        // --- Custom Molecule Recognizer for this page ---
        const MoleculeRecognizer = (() => {
            let index = new Map();
            let indexNoStereo = new Map();
            let oclAvailable = false;

            function isOclReady() {
                return !!(window.OCL && OCL.Molecule && typeof OCL.Molecule.fromSmiles === "function");
            }

            function normalizeSmiles(smiles) {
                if (!smiles) return "";
                return smiles.trim(); // Simplified normalization
            }

            function normalizeMolecule(mol) {
                if (!mol) return null;
                if (typeof mol.removeExplicitHydrogens === "function") {
                    try { mol.removeExplicitHydrogens(); } catch (err) {}
                }
                return mol;
            }

            function getIdCode(mol) {
                if (!mol || typeof mol.getIDCode !== "function") return null;
                try { return mol.getIDCode(); } catch (err) { return null; }
            }

            function getIdCodeNoStereo(mol) {
                if (!mol) return null;
                // Clone if possible to avoid mutating original
                let copy = mol; 
                if (typeof mol.getCompactCopy === "function") copy = mol.getCompactCopy();
                
                if (typeof copy.stripStereoInformation === "function") {
                    try { copy.stripStereoInformation(); } catch (err) { return null; }
                }
                return getIdCode(copy);
            }

            function ensureIndex() {
                if (index.size > 0) return;
                oclAvailable = isOclReady();
                if (!oclAvailable) {
                    for (const m of moleculesData) {
                        if (m.smiles) index.set(normalizeSmiles(m.smiles), m);
                    }
                    return;
                }
                for (const m of moleculesData) {
                    if (!m.smiles) continue;
                    try {
                        const mol = OCL.Molecule.fromSmiles(m.smiles);
                        normalizeMolecule(mol);
                        const id = getIdCode(mol);
                        if (id) index.set(id, m);
                        const idNoStereo = getIdCodeNoStereo(mol);
                        if (idNoStereo) indexNoStereo.set(idNoStereo, m);
                    } catch (e) { console.warn("Failed to index", m.name); }
                }
            }

            function identify(smiles) {
                ensureIndex();
                if (!smiles) return { found: false };
                
                if (!oclAvailable) {
                    const match = index.get(normalizeSmiles(smiles));
                    return match ? { found: true, match: 'string', ...match } : { found: false };
                }

                try {
                    const mol = OCL.Molecule.fromSmiles(smiles);
                    normalizeMolecule(mol);
                    const id = getIdCode(mol);
                    if (id && index.has(id)) {
                        return { found: true, match: 'exact', ...index.get(id) };
                    }
                    const idNoStereo = getIdCodeNoStereo(mol);
                    if (idNoStereo && indexNoStereo.has(idNoStereo)) {
                        return { found: true, match: 'nostereo', ...indexNoStereo.get(idNoStereo) };
                    }
                } catch(e) {}
                return { found: false };
            }

            function fromJSME(jsmeInstance) {
                if (!jsmeInstance) return { found: false };
                let smiles = '';
                if (typeof jsmeInstance.smiles === 'function') smiles = jsmeInstance.smiles();
                
                if (!smiles && typeof jsmeInstance.molFile === 'function') {
                    // Fallback to molfile parsing if smiles is empty/issue
                    // Simplified: just return not found if no smiles for now, 
                    // or implement molfile parsing if OCL is ready.
                    if (isOclReady()) {
                        try {
                            const mol = OCL.Molecule.fromMolfile(jsmeInstance.molFile());
                            normalizeMolecule(mol);
                            const id = getIdCode(mol);
                            if (id && index.has(id)) return { found: true, match: 'exact', ...index.get(id) };
                        } catch(e){}
                    }
                }
                return identify(smiles);
            }

            return { identify, fromJSME, isOclReady };
        })();

        function updateTabs() {
            document.querySelectorAll('.set-tab').forEach(tab => {
                const isActive = tab.dataset.set === currentSet;
                tab.classList.toggle('border-blue-600', isActive);
                tab.classList.toggle('text-blue-600', isActive);
                tab.classList.toggle('border-transparent', !isActive);
                tab.classList.toggle('text-slate-500', !isActive);
            });
        }

        function switchSub(sub) {
            currentSub = sub;
            const showBtn = document.getElementById('sub-show-btn');
            const drawBtn = document.getElementById('sub-draw-btn');
            const showSec = document.getElementById('section-show');
            const drawSec = document.getElementById('section-draw');

            const activeClasses = ['bg-slate-900', 'text-white', 'dark:bg-slate-100', 'dark:text-slate-900'];
            const inactiveClasses = ['text-slate-500', 'dark:text-slate-400', 'hover:text-slate-700', 'dark:hover:text-slate-200'];

            if (sub === 'show') {
                showBtn.classList.add(...activeClasses);
                showBtn.classList.remove(...inactiveClasses);
                drawBtn.classList.remove(...activeClasses);
                drawBtn.classList.add(...inactiveClasses);
                
                showSec.classList.remove('hidden');
                drawSec.classList.add('hidden');
                renderGrid();
            } else {
                drawBtn.classList.add(...activeClasses);
                drawBtn.classList.remove(...inactiveClasses);
                showBtn.classList.remove(...activeClasses);
                showBtn.classList.add(...inactiveClasses);

                showSec.classList.add('hidden');
                drawSec.classList.remove('hidden');
                if (!drawTarget) pickNewDrawTarget();
            }
        }

        // --- SHOW LOGIC ---
        function renderGrid() {
            const grid = document.getElementById('molecule-grid');
            if (!grid) return;
            grid.innerHTML = '';
            
            const SmiDrawer = window.SmiDrawer || SmilesDrawer.SmiDrawer;

            moleculesData.forEach((mol, idx) => {
                const card = document.createElement('div');
                card.className = `group relative bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden flex flex-col p-4 shadow-sm hover:shadow-md transition-shadow`;
                
                // Tags
                let tagsHtml = '';
                if (mol.tags) {
                    tagsHtml = `<div class="mt-3 flex flex-wrap gap-1">`;
                    mol.tags.forEach(tag => {
                        tagsHtml += `<span class="bg-slate-100 dark:bg-slate-800 text-slate-500 text-[10px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider">${tag}</span>`;
                    });
                    tagsHtml += `</div>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">${mol.name}</h3>
                            <div class="text-xs font-mono text-blue-600 dark:text-blue-400">${mol.abbr}</div>
                        </div>
                    </div>
                    <div class="flex-grow flex items-center justify-center py-4 bg-slate-50/50 dark:bg-slate-800/30 rounded-lg border border-slate-100 dark:border-slate-800 aspect-[3/2] w-full">
                        <canvas id="canvas-${idx}" class="w-full h-full object-contain"></canvas>
                    </div>
                    ${tagsHtml}
                `;
                grid.appendChild(card);
            });

            requestAnimationFrame(() => {
                moleculesData.forEach((mol, idx) => {
                    const smilesDrawer = new SmiDrawer({ width: 250, height: 200, padding: 10 });
                    smilesDrawer.draw(mol.smiles, `#canvas-${idx}`, 'light'); // Default to light, theme listener handles update
                });
            });
        }

        // --- DRAW LOGIC ---
        function jsmeOnLoad() {
            jsmeApplet = new JSApplet.JSME("jsme-container", "100%", "100%");
        }

        function pickNewDrawTarget() {
            if (!moleculesData.length) return;
            const next = moleculesData[Math.floor(Math.random() * moleculesData.length)];
            drawTarget = next;
            document.getElementById('draw-target-name').textContent = drawTarget.name;
            document.getElementById('draw-feedback').textContent = "Draw structure above";
            document.getElementById('draw-feedback').className = "text-lg font-bold text-slate-500";
            document.getElementById('draw-user-wrapper').classList.add('hidden');
            document.getElementById('draw-expected-wrapper').classList.add('hidden');
            
            if (jsmeApplet) jsmeApplet.reset();
        }

        function checkAnswer() {
            if (!drawTarget || !jsmeApplet) return;
            
            const userSmiles = jsmeApplet.smiles(); // Basic retrieval
            if (!userSmiles) {
                document.getElementById('draw-feedback').textContent = "Please draw something first.";
                return;
            }

            // Show User Drawing
            document.getElementById('draw-user-wrapper').classList.remove('hidden');
            const SmiDrawer = window.SmiDrawer || SmilesDrawer.SmiDrawer;
            const sdUser = new SmiDrawer({ width: 300, height: 200 });
            sdUser.draw(userSmiles, '#draw-user-canvas', 'light');

            // Show Expected
            document.getElementById('draw-expected-wrapper').classList.remove('hidden');
            const sdExpected = new SmiDrawer({ width: 300, height: 200 });
            sdExpected.draw(drawTarget.smiles, '#draw-expected-canvas', 'light');

            // Use the custom MoleculeRecognizer
            const result = MoleculeRecognizer.fromJSME(jsmeApplet);
            
            const fb = document.getElementById('draw-feedback');
            
            let isCorrect = false;
            let message = "Not quite.";
            
            if (result.found && result.name === drawTarget.name) {
                if (result.match === 'exact' || result.match === 'string') {
                    isCorrect = true;
                    message = "Correct!";
                } else if (result.match === 'nostereo') {
                    isCorrect = true; 
                    message = "Correct connectivity, but check stereochemistry.";
                }
            } else {
                if (result.found) {
                    message = `That looks like ${result.name}, but we wanted ${drawTarget.name}.`;
                }
            }

            if (isCorrect) {
                fb.textContent = message;
                fb.className = "text-lg font-bold text-emerald-600";
            } else {
                fb.textContent = message;
                fb.className = "text-lg font-bold text-red-600";
            }
        }

        window.addEventListener('load', () => {
            // Check URL for set parameter
            const params = new URLSearchParams(window.location.search);
            const setParam = params.get('set');
            if (setParam && (setParam === 'midterm1' || setParam === 'chapter1' || setParam === 'molecules')) {
                currentSet = setParam;
            }
            updateTabs();

            // Setup Sub-tabs
            document.getElementById('sub-show-btn').addEventListener('click', () => switchSub('show'));
            document.getElementById('sub-draw-btn').addEventListener('click', () => switchSub('draw'));
            
            // Setup Draw Controls
            document.getElementById('draw-next-btn').addEventListener('click', pickNewDrawTarget);
            document.getElementById('draw-clear-btn').addEventListener('click', () => {
                if (jsmeApplet) jsmeApplet.reset();
            });
            document.getElementById('draw-check-btn').addEventListener('click', checkAnswer);

            // Set Tab Links
            document.querySelectorAll('.set-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const set = tab.dataset.set;
                    if (set === 'molecules') return;
                    if (set === 'midterm1') window.location.href = '153b.html?set=midterm1';
                    if (set === 'chapter1') window.location.href = '153b.html?set=chapter1';
                });
            });

            // Initial Render
            renderGrid();
        });
    </script>