<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>153B - BioBioChem Flashcards</title>
    <link rel="preconnect" href="https://api.github.com" crossorigin>
    <link rel="dns-prefetch" href="https://api.github.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script>
        // Apply theme immediately to prevent flash
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 flex flex-col min-h-screen">

    <header class="bg-white dark:bg-slate-900 border-b dark:border-slate-800 sticky top-0 z-20 shadow-sm transition-colors transition-transform duration-300">

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col space-y-2 sm:space-y-4 py-2 sm:py-4">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 sm:gap-0 sm:h-16">
                    <div class="flex items-center justify-center sm:justify-start w-full sm:w-auto">
                        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50/80 dark:bg-slate-900/50 px-2 py-1.5 sm:px-3 sm:py-2 text-center sm:text-left">
                            <div class="text-[10px] sm:text-xs font-bold uppercase tracking-widest text-slate-800 dark:text-slate-100 text-center sm:text-left">mcat</div>
                            <div class="mt-0.5 sm:mt-1 flex flex-wrap items-center gap-2 text-[9px] sm:text-[10px] text-slate-500 justify-center sm:justify-start">
                                <span id="commit-hash">loading...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center justify-center sm:justify-end gap-3 sm:gap-6 w-full sm:w-auto">
                        <nav class="flex flex-wrap justify-center sm:justify-start gap-3 sm:gap-8" aria-label="153B">
                            <a href="index.html" class="nav-link py-2 sm:py-5 text-sm font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200" title="Home">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                            </a>
                            <a href="153b.html" class="nav-link active py-2 sm:py-5 text-sm font-medium text-blue-600 border-b-2 border-blue-600">Flashcards</a>
                        </nav>

                        <button onclick="toggleDarkMode()" class="p-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors shrink-0" title="Toggle Dark/Light Mode">
                            <svg id="sun-icon" class="hidden dark:block w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"></path>
                            </svg>
                            <svg id="moon-icon" class="block dark:hidden w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-center sm:justify-start">
                    <a href="index.html" class="inline-flex items-center justify-center w-9 h-9 rounded-full border border-slate-200 bg-white text-slate-500 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-300 dark:hover:bg-slate-800 transition-colors" aria-label="Home" title="Home">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow w-full px-4 sm:px-6 lg:px-8 py-6 flex flex-col">
        <section class="max-w-6xl mx-auto w-full flex flex-col">
            <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 mb-6">
                <div class="flex-grow">
                    <p class="text-xs uppercase tracking-[0.35em] text-slate-400 font-semibold">BioBioChem</p>
                    <h1 class="text-3xl sm:text-4xl font-black text-slate-900 dark:text-white">153B Midterm 1</h1>
                    <div class="mt-3 flex items-center gap-2 max-w-sm">
                        <div class="relative flex-grow group">
                            <input id="compact-save-code" type="text" placeholder="Paste code to load..." 
                                class="w-full pl-3 pr-16 sm:pr-8 py-1.5 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-[10px] font-mono text-slate-600 dark:text-slate-400 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
                                spellcheck="false" />
                            <div class="absolute right-1.5 top-1/2 -translate-y-1/2 flex items-center gap-0.5">
                                <button id="compact-paste-btn" class="sm:hidden p-1 text-slate-400 hover:text-blue-500 transition-colors" title="Paste Code">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                                </button>
                                <button id="compact-copy-btn" class="p-1 text-slate-400 hover:text-blue-500 transition-colors" title="Copy Code">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                                </button>
                            </div>
                        </div>
                        <span id="compact-status" class="text-[9px] font-bold uppercase tracking-wider text-slate-400 whitespace-nowrap">Ready</span>
                    </div>
                </div>
                <div class="flex flex-wrap items-center justify-center sm:justify-end gap-3">
                    <div class="inline-flex items-center rounded-full border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 p-1">
                        <button id="mode-anki-btn" class="mode-btn px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-widest transition-colors">Anki</button>
                        <button id="mode-free-btn" class="mode-btn px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-widest transition-colors">Free</button>
                    </div>
                    <button id="settings-btn" class="px-4 py-2 rounded-xl border border-slate-200 text-slate-600 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 transition-colors font-semibold flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>
                        Data
                    </button>
                </div>
            </div>

            <div id="flashcard-container" class="perspective-1000 flex-grow w-full relative mb-6 min-h-[420px] sm:min-h-[520px]">
                <div id="flashcard" class="absolute inset-0 w-full h-full transition-transform duration-500 transform-style-3d cursor-pointer" onclick="flipCard()">
                    <div id="flashcard-front" class="absolute inset-0 backface-hidden bg-white dark:bg-slate-900 rounded-3xl border-2 border-slate-200 dark:border-slate-800 shadow-2xl flex flex-col items-center justify-center p-6 sm:p-8">
                        <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-blue-500 uppercase tracking-widest mb-8 sm:mb-10">153B Prompt</h2>
                        <div id="flashcard-question" class="text-2xl sm:text-3xl md:text-5xl font-black text-slate-800 dark:text-white text-center tracking-tight leading-tight max-w-full sm:max-w-4xl"></div>
                        <p class="mt-10 sm:mt-12 text-slate-400 text-sm sm:text-base md:text-lg font-medium uppercase tracking-[0.3em] animate-pulse">Click to reveal</p>
                    </div>
                    <div id="flashcard-back" class="absolute inset-0 backface-hidden bg-white dark:bg-slate-900 rounded-3xl border-2 border-blue-500 dark:border-blue-500 shadow-2xl flex p-5 sm:p-6 md:p-8 rotate-y-180 overflow-hidden">
                        <div class="w-full h-full flex flex-col md:flex-row gap-5 sm:gap-8 items-stretch">
                            <div class="flex-[3] flex flex-col gap-3 sm:gap-4">
                                <div class="p-4 sm:p-6 rounded-2xl bg-blue-50/50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800/50">
                                    <p class="text-xs text-blue-500 uppercase font-bold tracking-wider mb-2">Answer</p>
                                    <p id="flashcard-answer" class="text-lg sm:text-2xl md:text-3xl font-black text-blue-700 dark:text-blue-200"></p>
                                </div>
                                <div id="flashcard-image-panel" class="rounded-2xl flex flex-col flex-1 min-h-[200px] sm:min-h-[240px] overflow-auto no-scrollbar">
                                    <div id="flashcard-images" class="grid gap-3 w-full h-full"></div>
                                </div>
                            </div>
                            <div class="flex-1 flex flex-col justify-center gap-3 sm:gap-4 w-full sm:min-w-[230px]">
                                <div class="p-4 sm:p-5 rounded-2xl bg-indigo-50/70 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-800/50">
                                    <p class="text-xs text-indigo-500 uppercase font-bold tracking-wider mb-1">Prompt</p>
                                    <p id="flashcard-prompt" class="text-lg sm:text-xl font-black text-indigo-700 dark:text-indigo-200"></p>
                                </div>
                                <div class="p-4 sm:p-5 rounded-2xl bg-emerald-50/60 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-800/50">
                                    <p id="flashcard-due-label" class="text-xs text-emerald-500 uppercase font-bold tracking-wider mb-1">Due</p>
                                    <p id="flashcard-due" class="text-base sm:text-lg font-black text-emerald-700 dark:text-emerald-200"></p>
                                </div>
                                <div class="p-4 sm:p-5 rounded-2xl bg-slate-100/60 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700">
                                    <p class="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">Card</p>
                                    <p id="flashcard-id" class="text-base sm:text-lg font-bold text-slate-700 dark:text-slate-200"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="shrink-0 py-2 flex flex-col items-center gap-4">
                <div class="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-4 w-full">
                    <button id="show-answer-btn" class="w-full sm:w-auto px-6 sm:px-10 py-3 sm:py-4 rounded-2xl bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 font-black text-base sm:text-lg hover:scale-105 active:scale-95 transition-all shadow-xl order-1 sm:order-2">Show Answer</button>
                    <div class="flex items-center justify-center gap-3 w-full sm:w-auto sm:contents order-2 sm:order-none">
                        <button id="prev-btn" class="p-3 sm:p-4 rounded-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors shadow-lg group order-2 sm:order-1" aria-label="Previous card">
                            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:-translate-x-1 transition-transform"><path d="m15 18-6-6 6-6"/></svg>
                        </button>
                        <button id="next-btn" class="p-3 sm:p-4 rounded-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors shadow-lg group order-3 sm:order-3" aria-label="Next card">
                            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="group-hover:translate-x-1 transition-transform"><path d="m9 18 6-6-6-6"/></svg>
                        </button>
                    </div>
                </div>
                <div id="rating-controls" class="hidden w-full max-w-xl grid grid-cols-2 gap-3 sm:flex sm:flex-wrap sm:justify-center">
                    <button class="rating-btn w-full sm:w-auto px-4 sm:px-5 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold transition-colors" data-grade="0">Again</button>
                    <button class="rating-btn w-full sm:w-auto px-4 sm:px-5 py-3 rounded-xl bg-amber-500 hover:bg-amber-600 text-white font-bold transition-colors" data-grade="1">Hard</button>
                    <button class="rating-btn w-full sm:w-auto px-4 sm:px-5 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold transition-colors" data-grade="2">Good</button>
                    <button class="rating-btn w-full sm:w-auto px-4 sm:px-5 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-bold transition-colors" data-grade="3">Easy</button>
                </div>
                <div class="text-sm font-bold text-slate-400 uppercase tracking-widest text-center">
                    Card: <span id="card-index" class="text-slate-900 dark:text-white">0</span> / <span id="card-total">0</span>
                </div>
                <div class="text-xs font-semibold text-slate-400 uppercase tracking-widest text-center">
                    Due: <span id="deck-due">0</span> | New: <span id="deck-new">0</span> | Total: <span id="deck-total">0</span>
                </div>
                <div id="deck-message" class="text-xs text-slate-500 text-center"></div>
            </div>

            <div id="progress-section" class="mt-8 hidden">
                <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-800">
                        <h2 class="text-lg font-bold">Anki Progress</h2>
                        <p class="text-xs text-slate-400 mt-1">Mastered after 3 straight correct reviews.</p>
                    </div>
                    <div class="w-full">
                        <table class="progress-table min-w-full text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-900/60 text-slate-500">
                                <tr>
                                    <th class="text-left font-semibold px-6 py-3">
                                        <button type="button" class="progress-sort-btn flex items-center gap-1 text-left" data-sort="card">
                                            <span>Card</span>
                                            <span class="sort-indicator text-[9px] text-slate-400"></span>
                                        </button>
                                    </th>
                                    <th class="text-left font-semibold px-6 py-3">
                                        <button type="button" class="progress-sort-btn flex items-center gap-1 text-left" data-sort="prompt">
                                            <span>Prompt</span>
                                            <span class="sort-indicator text-[9px] text-slate-400"></span>
                                        </button>
                                    </th>
                                    <th class="text-left font-semibold px-6 py-3">
                                        <button type="button" class="progress-sort-btn flex items-center gap-1 text-left" data-sort="streak">
                                            <span>Streak</span>
                                            <span class="sort-indicator text-[9px] text-slate-400"></span>
                                        </button>
                                    </th>
                                    <th class="text-left font-semibold px-6 py-3">
                                        <button type="button" class="progress-sort-btn flex items-center gap-1 text-left" data-sort="correct">
                                            <span>Correct</span>
                                            <span class="sort-indicator text-[9px] text-slate-400"></span>
                                        </button>
                                    </th>
                                    <th class="text-left font-semibold px-6 py-3">
                                        <button type="button" class="progress-sort-btn flex items-center gap-1 text-left" data-sort="wrong">
                                            <span>Wrong</span>
                                            <span class="sort-indicator text-[9px] text-slate-400"></span>
                                        </button>
                                    </th>
                                    <th class="text-left font-semibold px-6 py-3">
                                        <button type="button" class="progress-sort-btn flex items-center gap-1 text-left" data-sort="need">
                                            <span>Need</span>
                                            <span class="sort-indicator text-[9px] text-slate-400"></span>
                                        </button>
                                    </th>
                                    <th class="text-left font-semibold px-6 py-3">
                                        <button type="button" class="progress-sort-btn flex items-center gap-1 text-left" data-sort="due">
                                            <span>Due</span>
                                            <span class="sort-indicator text-[9px] text-slate-400"></span>
                                        </button>
                                    </th>
                                    <th class="text-left font-semibold px-6 py-3">
                                        <button type="button" class="progress-sort-btn flex items-center gap-1 text-left" data-sort="ease">
                                            <span>Ease</span>
                                            <span class="sort-indicator text-[9px] text-slate-400"></span>
                                        </button>
                                    </th>
                                    <th class="text-left font-semibold px-6 py-3">
                                        <button type="button" class="progress-sort-btn flex items-center gap-1 text-left" data-sort="interval">
                                            <span>Interval</span>
                                            <span class="sort-indicator text-[9px] text-slate-400"></span>
                                        </button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="progress-table" class="divide-y divide-slate-100 dark:divide-slate-800">
                                <!-- Rows injected by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="mt-12 bg-white dark:bg-slate-900 border-t dark:border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4"></div>
    </footer>

    <script src="script.js"></script>
    <script>
        const MT1_PROGRESS_STORAGE_KEY = 'midterm1_153b_progress_v1';
        const MT1_MASTERY_STREAK = 3;
        const MT1_EASE_START = 2.5;
        const MT1_EASE_MIN = 1.3;
        const MT1_EASE_MAX = 3.0;
        const MT1_LEARNING_STEPS_MS = [
            60000,
            5 * 60000,
            20 * 60000
        ];
        const MT1_GRADUATING_INTERVAL_MS = 24 * 60 * 60000;
        const MT1_EASY_INTERVAL_MS = 3 * 24 * 60 * 60000;
        const MT1_REVIEW_MIN_INTERVAL_MS = 10 * 60000;
        const MT1_REVIEW_MAX_INTERVAL_MS = 365 * 24 * 60 * 60000;
        const MT1_DEFAULT_ITEM = {
            correctStreak: 0,
            totalCorrect: 0,
            totalWrong: 0,
            lastSeen: null,
            mastered: false,
            dueAtMs: 0,
            intervalMs: 0,
            ease: MT1_EASE_START,
            learningStep: 0,
            reps: 0,
            lapses: 0,
            lastGrade: null
        };
        const MODE_STORAGE_KEY = 'midterm1_153b_mode_v1';
        const STUDY_MODE_ANKI = 'anki';
        const STUDY_MODE_FREE = 'free';

        let deckCards = [];
        let currentCard = null;
        let currentCardKey = null;
        let currentIndex = 0;
        let isFlipped = false;
        let studyMode = loadStudyMode();
        const progressSortState = { key: null, direction: 0 };

        function normalizeDeckCards(rawCards) {
            if (!Array.isArray(rawCards)) return [];
            return rawCards.map((card, idx) => {
                const safe = card && typeof card === 'object' ? card : {};
                const index = Number.isFinite(safe.index) ? safe.index : idx;
                const front = typeof safe.front === 'string' ? safe.front.trim() : '';
                const back = typeof safe.back === 'string' ? safe.back.trim() : '';
                const images = Array.isArray(safe.images)
                    ? safe.images.filter((img) => typeof img === 'string' && img.trim())
                    : [];
                return {
                    id: String(index),
                    index,
                    position: idx + 1,
                    front: front || `Card ${idx + 1}`,
                    back,
                    images
                };
            });
        }

        function getCardKey(card) {
            if (!card) return '';
            if (typeof card.id === 'string' && card.id) return card.id;
            if (Number.isFinite(card.index)) return String(card.index);
            if (typeof card.front === 'string' && card.front) return card.front;
            return '';
        }

        function loadStudyMode() {
            const stored = localStorage.getItem(MODE_STORAGE_KEY);
            return stored === STUDY_MODE_FREE ? STUDY_MODE_FREE : STUDY_MODE_ANKI;
        }

        function loadReviewProgress() {
            try {
                const raw = localStorage.getItem(MT1_PROGRESS_STORAGE_KEY);
                if (!raw) return { version: 1, items: {} };
                const parsed = JSON.parse(raw);
                if (!parsed || typeof parsed !== 'object') return { version: 1, items: {} };
                if (!parsed.items || typeof parsed.items !== 'object') parsed.items = {};
                return parsed;
            } catch (err) {
                return { version: 1, items: {} };
            }
        }

        function saveReviewProgress(progress) {
            localStorage.setItem(MT1_PROGRESS_STORAGE_KEY, JSON.stringify(progress));
            if (typeof updateCompactSaveCode === 'function') updateCompactSaveCode();
        }

        function normalizeReviewItem(item) {
            if (!item || typeof item !== 'object') return { ...MT1_DEFAULT_ITEM };
            return { ...MT1_DEFAULT_ITEM, ...item };
        }

        function ensureReviewItem(progress, key) {
            if (!progress.items[key] || typeof progress.items[key] !== 'object') {
                progress.items[key] = { ...MT1_DEFAULT_ITEM };
            } else {
                progress.items[key] = { ...MT1_DEFAULT_ITEM, ...progress.items[key] };
            }
            return progress.items[key];
        }

        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        function formatDuration(ms) {
            const seconds = Math.max(1, Math.round(ms / 1000));
            if (seconds < 60) return `${seconds}s`;
            const minutes = Math.round(seconds / 60);
            if (minutes < 60) return `${minutes}m`;
            const hours = Math.round(minutes / 60);
            if (hours < 48) return `${hours}h`;
            const days = Math.round(hours / 24);
            return `${days}d`;
        }

        function formatDueLabel(item, nowMs) {
            const dueAt = typeof item.dueAtMs === 'number' ? item.dueAtMs : 0;
            if (!dueAt || dueAt <= nowMs) return 'Due: now';
            return `Due in: ${formatDuration(dueAt - nowMs)}`;
        }

        function scheduleNext(item, grade, nowMs) {
            item.reps = (item.reps ?? 0) + 1;
            item.lastGrade = grade;

            if (typeof item.ease !== 'number') item.ease = MT1_EASE_START;
            item.ease = clamp(item.ease, MT1_EASE_MIN, MT1_EASE_MAX);
            if (typeof item.intervalMs !== 'number') item.intervalMs = 0;

            const inReview = item.learningStep == null;

            if (grade === 0) {
                item.lapses = (item.lapses ?? 0) + 1;
                item.learningStep = 0;
                item.intervalMs = MT1_LEARNING_STEPS_MS[0];
                item.dueAtMs = nowMs + item.intervalMs;
                if (inReview) item.ease = clamp(item.ease - 0.2, MT1_EASE_MIN, MT1_EASE_MAX);
                return;
            }

            if (item.learningStep != null) {
                if (grade === 3) {
                    item.learningStep = null;
                    item.intervalMs = MT1_EASY_INTERVAL_MS;
                    item.dueAtMs = nowMs + item.intervalMs;
                    return;
                }

                if (grade === 2) {
                    item.learningStep += 1;
                    if (item.learningStep >= MT1_LEARNING_STEPS_MS.length) {
                        item.learningStep = null;
                        item.intervalMs = MT1_GRADUATING_INTERVAL_MS;
                        item.dueAtMs = nowMs + item.intervalMs;
                    } else {
                        item.intervalMs = MT1_LEARNING_STEPS_MS[item.learningStep];
                        item.dueAtMs = nowMs + item.intervalMs;
                    }
                    return;
                }

                item.intervalMs = MT1_LEARNING_STEPS_MS[item.learningStep];
                item.dueAtMs = nowMs + item.intervalMs;
                return;
            }

            if (grade === 1) item.ease = clamp(item.ease - 0.15, MT1_EASE_MIN, MT1_EASE_MAX);
            if (grade === 3) item.ease = clamp(item.ease + 0.15, MT1_EASE_MIN, MT1_EASE_MAX);

            const factor = grade === 1 ? 0.8 : grade === 2 ? 1.0 : 1.3;
            const next = item.intervalMs * item.ease * factor;
            item.intervalMs = clamp(Math.round(next), MT1_REVIEW_MIN_INTERVAL_MS, MT1_REVIEW_MAX_INTERVAL_MS);
            item.dueAtMs = nowMs + item.intervalMs;
        }

        function weightedPick(candidates) {
            if (!candidates.length) return null;
            let total = 0;
            const weights = candidates.map((entry) => {
                const item = entry.item || {};
                const weight = 1 + (item.lapses || 0) + (item.totalWrong || 0);
                total += weight;
                return { entry, weight };
            });
            let roll = Math.random() * total;
            for (const { entry, weight } of weights) {
                if (roll <= weight) return entry;
                roll -= weight;
            }
            return weights[weights.length - 1].entry;
        }

        function selectNextCard(cards, progress, nowMs, currentKey) {
            const items = cards.map((card) => {
                const key = getCardKey(card);
                const item = normalizeReviewItem(progress.items[key]);
                const dueAt = typeof item.dueAtMs === 'number' ? item.dueAtMs : 0;
                return { card, item, dueAt, key };
            });
            const dueItems = items.filter((entry) => (entry.dueAt || 0) <= nowMs);
            let candidatePool = [];
            let selected = null;

            if (dueItems.length) {
                const sortedDue = [...dueItems].sort((a, b) => (a.dueAt || 0) - (b.dueAt || 0));
                candidatePool = sortedDue;
                const top = sortedDue.slice(0, Math.min(5, sortedDue.length));
                selected = weightedPick(top) || sortedDue[0];
            } else {
                const sortedItems = [...items].sort((a, b) => (a.dueAt || 0) - (b.dueAt || 0));
                candidatePool = sortedItems;
                selected = sortedItems[0];
            }

            if (selected && currentKey && selected.key === currentKey && candidatePool.length > 1) {
                const fallback = candidatePool.find((entry) => entry.key !== currentKey);
                if (fallback) selected = fallback;
            }
            return selected;
        }

        function getDeckStats(cards, progress, nowMs) {
            let due = 0;
            let newCount = 0;
            let nextDueMs = null;
            cards.forEach((card) => {
                const key = getCardKey(card);
                const item = normalizeReviewItem(progress.items[key]);
                const dueAt = typeof item.dueAtMs === 'number' ? item.dueAtMs : 0;
                if (!item.reps) newCount += 1;
                if ((dueAt || 0) <= nowMs) {
                    due += 1;
                } else if (!nextDueMs || dueAt < nextDueMs) {
                    nextDueMs = dueAt;
                }
            });
            return {
                due,
                newCount,
                total: cards.length,
                nextDueMs
            };
        }

        function renderImages(images, altBase) {
            const panel = document.getElementById('flashcard-image-panel');
            const grid = document.getElementById('flashcard-images');
            if (!panel || !grid) return;
            grid.innerHTML = '';
            if (!images.length) {
                panel.classList.add('hidden');
                return;
            }
            panel.classList.remove('hidden');
            grid.className = images.length > 1
                ? 'grid grid-cols-1 sm:grid-cols-2 gap-3 w-full h-full'
                : 'grid grid-cols-1 gap-3 w-full h-full';
            
            images.forEach((src, idx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center justify-center w-full h-full min-h-[220px] sm:min-h-[280px]';
                const img = document.createElement('img');
                img.src = src;
                img.alt = `${altBase} image ${idx + 1}`;
                img.loading = 'lazy';
                img.className = 'max-h-full max-w-full object-contain';
                wrapper.appendChild(img);
                grid.appendChild(wrapper);
            });
        }

        function setModeButtonState(button, active) {
            if (!button) return;
            const activeClasses = ['bg-slate-900', 'text-white', 'dark:bg-slate-100', 'dark:text-slate-900', 'shadow-sm'];
            const inactiveClasses = ['text-slate-500', 'dark:text-slate-400', 'hover:text-slate-700', 'dark:hover:text-slate-200'];
            activeClasses.forEach((name) => button.classList.toggle(name, active));
            inactiveClasses.forEach((name) => button.classList.toggle(name, !active));
            button.setAttribute('aria-pressed', active ? 'true' : 'false');
        }

        function updateModeUI() {
            const isAnki = studyMode === STUDY_MODE_ANKI;
            const ankiBtn = document.getElementById('mode-anki-btn');
            const freeBtn = document.getElementById('mode-free-btn');
            setModeButtonState(ankiBtn, isAnki);
            setModeButtonState(freeBtn, !isAnki);

            const dueLabel = document.getElementById('flashcard-due-label');
            if (dueLabel) dueLabel.textContent = isAnki ? 'Due' : 'Mode';

            const prevBtn = document.getElementById('prev-btn');
            if (prevBtn) {
                prevBtn.disabled = isAnki;
                prevBtn.setAttribute('aria-disabled', String(isAnki));
                prevBtn.classList.toggle('opacity-50', isAnki);
                prevBtn.classList.toggle('cursor-not-allowed', isAnki);
                prevBtn.title = isAnki ? 'Previous disabled in Anki mode' : 'Previous card';
            }

            const nextBtn = document.getElementById('next-btn');
            if (nextBtn) {
                const label = isAnki ? 'Next due card' : 'Next card';
                nextBtn.title = label;
                nextBtn.setAttribute('aria-label', label);
            }

            updateFlipState();
            updateSortIndicators();
            renderProgressTable(loadReviewProgress());
        }

        function setStudyMode(mode) {
            if (mode !== STUDY_MODE_ANKI && mode !== STUDY_MODE_FREE) return;
            if (studyMode === mode) return;
            studyMode = mode;
            localStorage.setItem(MODE_STORAGE_KEY, studyMode);
            if (currentCardKey) {
                const idx = deckCards.findIndex((card) => getCardKey(card) === currentCardKey);
                if (idx >= 0) currentIndex = idx;
            }
            const progress = loadReviewProgress();
            updateModeUI();
            updateFlashcard(progress);
            updateDeckStatus(progress);
        }

        function formatInterval(item) {
            if (!item || typeof item.intervalMs !== 'number' || item.intervalMs <= 0) return '-';
            return formatDuration(item.intervalMs);
        }

        function formatDueShort(item, nowMs) {
            const dueAt = typeof item.dueAtMs === 'number' ? item.dueAtMs : 0;
            if (!dueAt || dueAt <= nowMs) return 'Now';
            return `In ${formatDuration(dueAt - nowMs)}`;
        }

        function getSortValue(row, key) {
            switch (key) {
                case 'card':
                    return row.position;
                case 'prompt':
                    return row.prompt.toLowerCase();
                case 'streak':
                    return row.streak;
                case 'correct':
                    return row.correct;
                case 'wrong':
                    return row.wrong;
                case 'need':
                    return row.need;
                case 'due':
                    return row.dueAt;
                case 'ease':
                    return row.ease;
                case 'interval':
                    return row.intervalMs;
                default:
                    return row.position;
            }
        }

        function compareSortRows(a, b, key, direction) {
            const av = getSortValue(a, key);
            const bv = getSortValue(b, key);
            if (typeof av === 'string' || typeof bv === 'string') {
                const aStr = String(av);
                const bStr = String(bv);
                if (aStr === bStr) return (a.position - b.position) * direction;
                return aStr.localeCompare(bStr) * direction;
            }
            const aNum = Number.isFinite(av) ? av : 0;
            const bNum = Number.isFinite(bv) ? bv : 0;
            if (aNum === bNum) return (a.position - b.position) * direction;
            return (aNum - bNum) * direction;
        }

        function updateSortIndicators() {
            document.querySelectorAll('.progress-sort-btn').forEach((btn) => {
                const key = btn.dataset.sort;
                const indicator = btn.querySelector('.sort-indicator');
                let label = '';
                let ariaSort = 'none';
                if (progressSortState.key === key) {
                    if (progressSortState.direction === 1) {
                        label = '^';
                        ariaSort = 'ascending';
                    } else if (progressSortState.direction === -1) {
                        label = 'v';
                        ariaSort = 'descending';
                    }
                }
                if (indicator) indicator.textContent = label;
                btn.setAttribute('aria-sort', ariaSort);
            });
        }

        function toggleProgressSort(key) {
            if (progressSortState.key !== key) {
                progressSortState.key = key;
                progressSortState.direction = 1;
            } else if (progressSortState.direction === 1) {
                progressSortState.direction = -1;
            } else {
                progressSortState.key = null;
                progressSortState.direction = 0;
            }
            updateSortIndicators();
            renderProgressTable(loadReviewProgress());
        }

        function renderProgressTable(progress, nowMs) {
            const section = document.getElementById('progress-section');
            const tbody = document.getElementById('progress-table');
            if (!section || !tbody) return;
            if (studyMode !== STUDY_MODE_ANKI) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');
            const progressState = progress || loadReviewProgress();
            const now = nowMs || Date.now();

            if (!deckCards.length) {
                tbody.innerHTML = '<tr><td class="px-6 py-6 text-slate-500" colspan="9">No cards loaded.</td></tr>';
                return;
            }

            const rows = deckCards.map((card) => {
                const key = getCardKey(card);
                const item = normalizeReviewItem(progressState.items[key]);
                return {
                    position: card.position,
                    prompt: card.front || '',
                    streak: item.correctStreak,
                    correct: item.totalCorrect,
                    wrong: item.totalWrong,
                    need: Math.max(0, MT1_MASTERY_STREAK - item.correctStreak),
                    dueAt: typeof item.dueAtMs === 'number' ? item.dueAtMs : 0,
                    dueLabel: formatDueShort(item, now),
                    ease: typeof item.ease === 'number' ? item.ease : MT1_EASE_START,
                    intervalMs: typeof item.intervalMs === 'number' ? item.intervalMs : 0,
                    mastered: item.mastered
                };
            });

            let renderRows = rows;
            if (progressSortState.key && progressSortState.direction) {
                renderRows = [...rows].sort((a, b) => compareSortRows(a, b, progressSortState.key, progressSortState.direction));
            }

            tbody.innerHTML = renderRows.map((row) => {
                const masteryLabel = row.mastered ? 'Mastered' : `Need ${row.need}`;
                const masteryClass = row.mastered ? 'text-emerald-600' : 'text-slate-500';
                const dueClass = row.dueAt && row.dueAt > now ? 'text-slate-500' : 'text-emerald-600';
                const streakLabel = `${row.streak}/${MT1_MASTERY_STREAK}`;

                return `
                    <tr>
                        <td class="px-6 py-4 font-semibold text-slate-800 dark:text-slate-100" data-label="Card">#${row.position}</td>
                        <td class="px-6 py-4 text-slate-700 dark:text-slate-200 sm:max-w-[240px] sm:truncate break-words" title="${row.prompt}" data-label="Prompt">${row.prompt}</td>
                        <td class="px-6 py-4 text-slate-500" data-label="Streak">${streakLabel}</td>
                        <td class="px-6 py-4 text-slate-500" data-label="Correct">${row.correct}</td>
                        <td class="px-6 py-4 text-slate-500" data-label="Wrong">${row.wrong}</td>
                        <td class="px-6 py-4 ${masteryClass}" data-label="Need">${masteryLabel}</td>
                        <td class="px-6 py-4 ${dueClass}" data-label="Due">${row.dueLabel}</td>
                        <td class="px-6 py-4 text-slate-500" data-label="Ease">${row.ease.toFixed(2)}</td>
                        <td class="px-6 py-4 text-slate-500" data-label="Interval">${formatInterval(row)}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateDeckStatus(progress) {
            const message = document.getElementById('deck-message');
            if (studyMode === STUDY_MODE_FREE) {
                document.getElementById('deck-due').textContent = '-';
                document.getElementById('deck-new').textContent = '-';
                document.getElementById('deck-total').textContent = String(deckCards.length);
                if (message) message.textContent = 'Free mode: no scheduling or ratings.';
                renderProgressTable(progress, Date.now());
                return;
            }
            const progressState = progress || loadReviewProgress();
            const nowMs = Date.now();
            const stats = getDeckStats(deckCards, progressState, nowMs);
            document.getElementById('deck-due').textContent = String(stats.due);
            document.getElementById('deck-new').textContent = String(stats.newCount);
            document.getElementById('deck-total').textContent = String(stats.total);
            if (stats.due === 0 && stats.nextDueMs) {
                message.textContent = `All caught up. Next due in ${formatDuration(stats.nextDueMs - nowMs)}.`;
            } else if (stats.due === 0) {
                message.textContent = 'All caught up.';
            } else {
                message.textContent = '';
            }
            renderProgressTable(progressState, nowMs);
        }

        function updateFlashcard(progress) {
            const progressState = progress || loadReviewProgress();
            const questionEl = document.getElementById('flashcard-question');
            const answerEl = document.getElementById('flashcard-answer');
            const promptEl = document.getElementById('flashcard-prompt');
            const dueEl = document.getElementById('flashcard-due');
            const idEl = document.getElementById('flashcard-id');
            const indexEl = document.getElementById('card-index');
            const totalEl = document.getElementById('card-total');
            const showBtn = document.getElementById('show-answer-btn');

            if (!currentCard) {
                questionEl.textContent = 'No cards available.';
                answerEl.textContent = '-';
                promptEl.textContent = '-';
                dueEl.textContent = '-';
                idEl.textContent = '-';
                indexEl.textContent = '0';
                totalEl.textContent = '0';
                showBtn.disabled = true;
                showBtn.classList.add('opacity-60', 'cursor-not-allowed');
                renderImages([], '');
                return;
            }

            const key = getCardKey(currentCard);
            const item = normalizeReviewItem(progressState.items[key]);
            const nowMs = Date.now();
            questionEl.textContent = currentCard.front;
            answerEl.textContent = currentCard.back || 'No answer provided.';
            promptEl.textContent = currentCard.front;
            dueEl.textContent = studyMode === STUDY_MODE_ANKI ? formatDueLabel(item, nowMs) : 'Free mode';
            idEl.textContent = `#${currentCard.position}`;
            indexEl.textContent = String(currentCard.position);
            totalEl.textContent = String(deckCards.length);
            showBtn.disabled = false;
            showBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            renderImages(currentCard.images, currentCard.front);
        }

        function updateFlipState() {
            const card = document.getElementById('flashcard');
            if (!card) return;
            card.classList.toggle('flipped', isFlipped);
            document.getElementById('rating-controls').classList.toggle('hidden', !isFlipped || studyMode !== STUDY_MODE_ANKI);
            const showBtn = document.getElementById('show-answer-btn');
            showBtn.textContent = isFlipped ? 'Hide Answer' : 'Show Answer';
        }

        function pickNextCard() {
            if (!deckCards.length) {
                currentCard = null;
                currentCardKey = null;
                currentIndex = 0;
                isFlipped = false;
                const progress = loadReviewProgress();
                updateFlashcard(progress);
                updateDeckStatus(progress);
                updateFlipState();
                return;
            }
            const progress = loadReviewProgress();
            const nowMs = Date.now();
            const selection = selectNextCard(deckCards, progress, nowMs, currentCardKey);
            const next = selection ? selection.card : deckCards[Math.floor(Math.random() * deckCards.length)];
            currentCard = next;
            currentCardKey = getCardKey(next);
            currentIndex = Math.max(0, deckCards.findIndex((card) => getCardKey(card) === currentCardKey));
            isFlipped = false;
            updateFlashcard(progress);
            updateDeckStatus(progress);
            updateFlipState();
        }

        function flipCard() {
            if (!currentCard) return;
            isFlipped = !isFlipped;
            updateFlipState();
        }

        function setCurrentCardByIndex(index, progress) {
            if (!deckCards.length) {
                pickNextCard();
                return;
            }
            const total = deckCards.length;
            const normalized = ((index % total) + total) % total;
            currentIndex = normalized;
            currentCard = deckCards[currentIndex];
            currentCardKey = getCardKey(currentCard);
            isFlipped = false;
            const progressState = progress || loadReviewProgress();
            updateFlashcard(progressState);
            updateDeckStatus(progressState);
            updateFlipState();
        }

        function nextCardManual() {
            if (studyMode === STUDY_MODE_ANKI) {
                pickNextCard();
                return;
            }
            setCurrentCardByIndex(currentIndex + 1);
        }

        function prevCardManual() {
            if (studyMode === STUDY_MODE_ANKI) return;
            setCurrentCardByIndex(currentIndex - 1);
        }

        function rateCard(grade) {
            if (studyMode !== STUDY_MODE_ANKI || !currentCard || !isFlipped) return;
            const progress = loadReviewProgress();
            const key = getCardKey(currentCard);
            const item = ensureReviewItem(progress, key);
            const nowMs = Date.now();
            item.lastSeen = new Date(nowMs).toISOString();
            const isCorrect = grade > 0;
            if (isCorrect) {
                item.correctStreak += 1;
                item.totalCorrect += 1;
                if (item.correctStreak >= MT1_MASTERY_STREAK) {
                    item.mastered = true;
                }
            } else {
                item.totalWrong += 1;
                item.correctStreak = 0;
            }
            scheduleNext(item, grade, nowMs);
            saveReviewProgress(progress);
            pickNextCard();
        }

        function openClearModal() {
            document.getElementById('clear-modal').classList.remove('hidden');
        }

        function closeClearModal() {
            document.getElementById('clear-modal').classList.add('hidden');
        }

        const HISTORY_STORAGE_KEY = 'midterm1_153b_history_v1';
        const MAX_HISTORY_ITEMS = 8;

        function clearProgress() {
            // Backup before clearing
            addToHistory(loadReviewProgress());
            localStorage.removeItem(MT1_PROGRESS_STORAGE_KEY);
            
            // UI Update
            if (studyMode === STUDY_MODE_ANKI) {
                pickNextCard();
            } else {
                updateFlashcard(loadReviewProgress());
                updateDeckStatus(loadReviewProgress());
                updateFlipState();
            }
            
            // Refresh settings UI if open
            if (!document.getElementById('settings-modal').classList.contains('hidden')) {
                refreshSettingsUI();
            }
        }

        // --- Unified Data Management Logic ---

        function openSettings() {
            refreshSettingsUI();
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function refreshSettingsUI() {
            const progress = loadReviewProgress();
            const code = generateSaveCode(progress);
            const io = document.getElementById('data-io');
            
            // Only update value if not currently focused to avoid fighting the user
            if (document.activeElement !== io) {
                io.value = code;
            }
            
            renderHistory();
            setStatus('Ready');
        }

        function setStatus(msg, type = 'neutral') {
            const el = document.getElementById('sync-status');
            el.textContent = msg;
            el.className = 'text-[10px] font-bold uppercase tracking-wider transition-colors';
            if (type === 'success') el.classList.add('text-emerald-500');
            else if (type === 'error') el.classList.add('text-red-500');
            else el.classList.add('text-slate-400');
        }

        function handleDataInput(e) {
            const input = e.target.value.trim();
            if (!input) return;

            // Don't react to the current code (no-op)
            const currentCode = generateSaveCode(loadReviewProgress());
            if (input === currentCode) {
                setStatus('Ready');
                return;
            }

            const decoded = parseSaveCode(input);
            if (decoded && decoded.items) {
                // Valid Data!
                // 1. Save current state to history
                addToHistory(loadReviewProgress());
                
                // 2. Apply new state
                saveReviewProgress(decoded);
                
                // 3. Update App UI
                if (studyMode === STUDY_MODE_ANKI) pickNextCard();
                else updateFlashcard(decoded);
                updateDeckStatus(decoded);
                
                // 4. Update Settings UI status
                setStatus('Loaded!', 'success');
                renderHistory();
                
                // Optional: Flash the border green
                e.target.classList.add('border-emerald-500');
                setTimeout(() => e.target.classList.remove('border-emerald-500'), 1000);
            } else {
                // Invalid
                setStatus('Invalid Code', 'error');
            }
        }

        function updateCompactSaveCode() {
            const progress = loadReviewProgress();
            const code = generateSaveCode(progress);
            const input = document.getElementById('compact-save-code');
            if (!input) return;
            
            if (document.activeElement !== input) {
                input.value = code;
            }
        }

        function setCompactStatus(msg, type = 'neutral') {
            const el = document.getElementById('compact-status');
            if (!el) return;
            el.textContent = msg;
            if (type === 'success') {
                el.className = 'text-[9px] font-bold uppercase tracking-wider text-emerald-500 whitespace-nowrap';
            } else if (type === 'error') {
                el.className = 'text-[9px] font-bold uppercase tracking-wider text-red-500 whitespace-nowrap';
            } else {
                el.className = 'text-[9px] font-bold uppercase tracking-wider text-slate-400 whitespace-nowrap';
            }
        }

        function handleCompactDataInput(e) {
            const input = e.target.value.trim();
            if (!input) return;

            const currentCode = generateSaveCode(loadReviewProgress());
            if (input === currentCode) {
                setCompactStatus('Ready');
                return;
            }

            const decoded = parseSaveCode(input);
            if (decoded && decoded.items) {
                addToHistory(loadReviewProgress());
                saveReviewProgress(decoded);
                
                if (studyMode === STUDY_MODE_ANKI) pickNextCard();
                else updateFlashcard(decoded);
                updateDeckStatus(decoded);
                
                setCompactStatus('Loaded!', 'success');
                setTimeout(() => setCompactStatus('Ready'), 2000);
            } else {
                setCompactStatus('Invalid', 'error');
            }
        }

        function addToHistory(progress) {
            // Don't save empty states to history
            const code = generateSaveCode(progress);
            const emptyCode = generateSaveCode({ version: 1, items: {} });
            if (code === emptyCode) return;

            let history = loadHistory();
            
            // Deduplicate: Don't add if identical to latest
            if (history.length > 0 && history[0].code === code) return;

            history.unshift({
                code: code,
                timestamp: Date.now(),
                stats: getDeckStats(deckCards, progress, Date.now()) // Snapshot stats for label
            });

            if (history.length > MAX_HISTORY_ITEMS) {
                history = history.slice(0, MAX_HISTORY_ITEMS);
            }

            localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
        }

        function loadHistory() {
            try {
                const raw = localStorage.getItem(HISTORY_STORAGE_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                return [];
            }
        }

        function restoreHistoryItem(index) {
            const history = loadHistory();
            const item = history[index];
            if (!item) return;

            // Current becomes history before we restore old history
            addToHistory(loadReviewProgress());

            const decoded = parseSaveCode(item.code);
            if (decoded) {
                saveReviewProgress(decoded);
                refreshSettingsUI();
                
                // Update App UI
                if (studyMode === STUDY_MODE_ANKI) pickNextCard();
                else updateFlashcard(decoded);
                updateDeckStatus(decoded);
                
                setStatus('Restored', 'success');
            }
        }

        function clearHistory() {
            localStorage.removeItem(HISTORY_STORAGE_KEY);
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const history = loadHistory();
            
            if (history.length === 0) {
                list.innerHTML = '<div class="text-[10px] text-slate-400 italic text-center py-2">No history available.</div>';
                return;
            }

            list.innerHTML = history.map((item, idx) => {
                const date = new Date(item.timestamp);
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateStr = date.toLocaleDateString();
                const dueCount = item.stats ? item.stats.due : '?';
                const masteredCount = item.stats ? (item.stats.total - item.stats.newCount) : '?'; // Rough approx
                
                return `
                    <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 hover:border-blue-200 dark:hover:border-blue-800 transition-colors group">
                        <div>
                            <div class="text-[10px] font-bold text-slate-600 dark:text-slate-300 uppercase tracking-wide">${dateStr} ${timeStr}</div>
                            <div class="text-[10px] text-slate-400">Due: ${dueCount}</div>
                        </div>
                        <button onclick="restoreHistoryItem(${idx})" class="px-3 py-1.5 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-[10px] font-bold text-slate-500 hover:text-blue-600 dark:text-slate-400 dark:hover:text-blue-400 shadow-sm transition-colors">
                            Restore
                        </button>
                    </div>
                `;
            }).join('');
        }

        function copyDataToClipboard() {
            const io = document.getElementById('data-io');
            io.select();
            io.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(io.value).then(() => {
                setStatus('Copied!', 'success');
                setTimeout(() => setStatus('Ready'), 2000);
            });
        }

        // Minify: Convert object to dense array format [v1, itemsMap]
        // Item: [streak, totalCorrect, totalWrong, lastSeen(ts), mastered(0/1), due(ts), interval, ease, learningStep, reps, lapses, lastGrade]
        function generateSaveCode(progress) {
            const items = progress.items || {};
            const packedItems = {};
            
            Object.keys(items).forEach(key => {
                const item = items[key];
                if (!item.reps && !item.lastSeen && !item.correctStreak) return;

                const packed = [
                    item.correctStreak || 0,
                    item.totalCorrect || 0,
                    item.totalWrong || 0,
                    item.lastSeen ? new Date(item.lastSeen).getTime() : 0,
                    item.mastered ? 1 : 0,
                    item.dueAtMs || 0,
                    item.intervalMs || 0,
                    Math.round((item.ease || 2.5) * 100),
                    item.learningStep === null ? -1 : (item.learningStep || 0),
                    item.reps || 0,
                    item.lapses || 0,
                    item.lastGrade === null ? -1 : item.lastGrade
                ];
                packedItems[key] = packed;
            });

            const payload = {
                v: 1,
                d: packedItems,
                ts: Date.now()
            };

            try {
                return btoa(JSON.stringify(payload));
            } catch (e) {
                console.error("Encoding error", e);
                return "";
            }
        }

        function parseSaveCode(code) {
            try {
                const json = atob(code);
                const payload = JSON.parse(json);
                if (payload.v !== 1 || !payload.d) return null;

                const restoredItems = {};
                Object.keys(payload.d).forEach(key => {
                    const p = payload.d[key];
                    if (!Array.isArray(p)) return;

                    restoredItems[key] = {
                        correctStreak: p[0],
                        totalCorrect: p[1],
                        totalWrong: p[2],
                        lastSeen: p[3] ? new Date(p[3]).toISOString() : null,
                        mastered: !!p[4],
                        dueAtMs: p[5],
                        intervalMs: p[6],
                        ease: p[7] / 100,
                        learningStep: p[8] === -1 ? null : p[8],
                        reps: p[9],
                        lapses: p[10],
                        lastGrade: p[11] === -1 ? null : p[11]
                    };
                });

                return {
                    version: 1,
                    items: restoredItems
                };
            } catch (e) {
                return null;
            }
        }

        window.addEventListener('load', () => {
            const rawDeck = typeof midterm1Cards !== 'undefined' ? midterm1Cards : [];
            deckCards = normalizeDeckCards(rawDeck);
            document.getElementById('mode-anki-btn').addEventListener('click', () => setStudyMode(STUDY_MODE_ANKI));
            document.getElementById('mode-free-btn').addEventListener('click', () => setStudyMode(STUDY_MODE_FREE));
            document.querySelectorAll('.progress-sort-btn').forEach((btn) => {
                btn.addEventListener('click', () => toggleProgressSort(btn.dataset.sort));
            });
            document.getElementById('prev-btn').addEventListener('click', prevCardManual);
            document.getElementById('show-answer-btn').addEventListener('click', flipCard);
            document.getElementById('next-btn').addEventListener('click', nextCardManual);
            document.querySelectorAll('.rating-btn').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const grade = Number(btn.dataset.grade);
                    if (Number.isFinite(grade)) rateCard(grade);
                });
            });
            
            // Settings / Data Events
            document.getElementById('settings-btn').addEventListener('click', openSettings);
            document.getElementById('settings-close-x').addEventListener('click', closeSettings);
            document.getElementById('settings-done-btn').addEventListener('click', closeSettings);
            document.getElementById('settings-backdrop').addEventListener('click', closeSettings);
            document.getElementById('nuke-btn').addEventListener('click', clearProgress);
            document.getElementById('copy-io-btn').addEventListener('click', copyDataToClipboard);
            document.getElementById('data-io').addEventListener('input', handleDataInput);
            document.getElementById('clear-history-btn').addEventListener('click', clearHistory);

            // Compact Save Code Events
            const compactInput = document.getElementById('compact-save-code');
            if (compactInput) {
                compactInput.addEventListener('input', handleCompactDataInput);
                compactInput.addEventListener('focus', () => compactInput.select());
            }
            const compactPasteBtn = document.getElementById('compact-paste-btn');
            if (compactPasteBtn) {
                compactPasteBtn.addEventListener('click', () => {
                    navigator.clipboard.readText().then(text => {
                        const input = document.getElementById('compact-save-code');
                        input.value = text;
                        handleCompactDataInput({ target: input });
                    }).catch(err => {
                        setCompactStatus('Paste Error', 'error');
                    });
                });
            }
            const compactCopyBtn = document.getElementById('compact-copy-btn');
            if (compactCopyBtn) {
                compactCopyBtn.addEventListener('click', () => {
                    const val = document.getElementById('compact-save-code').value;
                    navigator.clipboard.writeText(val).then(() => {
                        setCompactStatus('Copied!', 'success');
                        setTimeout(() => setCompactStatus('Ready'), 2000);
                    });
                });
            }
            updateCompactSaveCode();

            updateModeUI();
            if (studyMode === STUDY_MODE_ANKI) {
                pickNextCard();
            } else {
                setCurrentCardByIndex(0, loadReviewProgress());
            }
        });

        window.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                flipCard();
            } else if (e.key === '1') {
                rateCard(0);
            } else if (e.key === '2') {
                rateCard(1);
            } else if (e.key === '3') {
                rateCard(2);
            } else if (e.key === '4') {
                rateCard(3);
            } else if (e.key === 'ArrowRight') {
                nextCardManual();
            } else if (e.key === 'ArrowLeft') {
                prevCardManual();
            }
        });
    </script>

    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div id="settings-backdrop" class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="relative bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-2xl w-full max-w-lg mx-4 flex flex-col max-h-[85vh]">
            <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between">
                <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>
                    Data Management
                </h3>
                <button id="settings-close-x" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Live Sync Section -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs font-bold uppercase tracking-wider text-slate-500">Sync Code</label>
                        <span id="sync-status" class="text-[10px] font-bold uppercase tracking-wider text-slate-400 transition-colors">Ready</span>
                    </div>
                    <div class="relative group">
                        <textarea id="data-io" class="w-full h-32 p-4 rounded-xl bg-slate-50 dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 text-xs font-mono text-slate-600 dark:text-slate-300 resize-none focus:border-blue-500 focus:ring-0 outline-none transition-colors" spellcheck="false"></textarea>
                        <div class="absolute bottom-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button id="copy-io-btn" class="p-1.5 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-500 hover:text-blue-600 shadow-sm" title="Copy">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                            </button>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 leading-relaxed">
                        <strong class="text-slate-500 dark:text-slate-400">Copy</strong> this code to save/transfer your progress.<br>
                        <strong class="text-slate-500 dark:text-slate-400">Paste</strong> a code here to immediately load it.
                    </p>
                </div>

                <!-- History Section -->
                <div id="history-section" class="border-t border-slate-100 dark:border-slate-800 pt-6">
                    <div class="flex items-center justify-between mb-3">
                        <label class="text-xs font-bold uppercase tracking-wider text-slate-500">History / Backups</label>
                        <button id="clear-history-btn" class="text-[10px] font-semibold text-slate-400 hover:text-red-500 transition-colors">Clear History</button>
                    </div>
                    <div id="history-list" class="space-y-2">
                        <!-- History items injected here -->
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50 flex justify-between items-center rounded-b-2xl">
                <button id="nuke-btn" class="px-4 py-2 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 dark:border-red-900/30 dark:text-red-400 dark:hover:bg-red-900/20 text-xs font-bold uppercase tracking-wider transition-colors">
                    Reset All Progress
                </button>
                <button id="settings-done-btn" class="px-6 py-2 rounded-lg bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 hover:opacity-90 transition-opacity font-bold shadow-lg">
                    Done
                </button>
            </div>
        </div>
    </div>
</body>
</html>
