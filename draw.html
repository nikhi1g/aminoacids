--- 
--- 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw - Amino Acid Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script>
        // Apply theme immediately to prevent flash
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <script src="https://unpkg.com/jsme-editor@latest/jsme.nocache.js"></script>
    <script src="https://unpkg.com/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body data-page="draw" data-show-filters="true" class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 flex flex-col min-h-screen">
    {% include header.html %}



    <main class="flex-grow max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
            <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-lg p-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold">Draw the structure</h2>
                    <button id="new-target-btn" class="px-3 py-2 rounded-xl bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 font-semibold text-sm hover:scale-105 transition-transform">
                        New Prompt
                    </button>
                </div>
                <div id="jsme-container" class="jsme-container"></div>
                <div class="mt-4 flex items-center gap-3">
                    <button id="check-answer-btn" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold">Check Answer</button>
                    <button id="clear-drawing-btn" class="px-4 py-2 rounded-xl border border-slate-200 text-slate-600 hover:bg-slate-50 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 font-semibold">Clear</button>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-lg p-6 space-y-6">
                <div>
                    <p class="text-xs uppercase tracking-widest text-slate-400">Prompt</p>
                    <h3 id="draw-target-name" class="text-3xl font-black text-slate-800 dark:text-white">Loading...</h3>
                    <p class="text-sm text-slate-500">Draw the amino acid above using the editor.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-slate-50 dark:bg-slate-800/40 rounded-xl p-4 border border-slate-100 dark:border-slate-800">
                        <p class="text-xs uppercase tracking-widest text-slate-400">Your SMILES</p>
                        <p id="draw-user-smiles" class="text-xs font-mono text-slate-600 dark:text-slate-300 break-all">-</p>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800/40 rounded-xl p-4 border border-slate-100 dark:border-slate-800">
                        <p class="text-xs uppercase tracking-widest text-slate-400">Expected SMILES</p>
                        <p id="draw-expected-smiles" class="text-xs font-mono text-slate-600 dark:text-slate-300 break-all">-</p>
                    </div>
                </div>

                <div class="bg-slate-50/60 dark:bg-slate-800/30 rounded-xl border border-slate-100 dark:border-slate-800 p-4">
                    <p class="text-xs uppercase tracking-widest text-slate-400 mb-2">Expected Structure</p>
                    <div class="flex items-center justify-center min-h-[220px]">
                        <canvas id="draw-expected-canvas" class="w-full h-full"></canvas>
                    </div>
                </div>

                <div id="draw-feedback" class="text-lg font-bold text-slate-600">Draw the structure, then check your answer.</div>
            </div>
        </div>
    </main>

    {% include footer.html %}

    <script src="script.js"></script>
    <script>
        let jsmeApplet = null;
        let drawTarget = null;

        function jsmeOnLoad() {
            jsmeApplet = new JSApplet.JSME("jsme-container", "100%", "100%");
            if (drawTarget) {
                updateExpectedStructure();
            }
        }

        function normalizeSmiles(smiles) {
            if (!smiles) return '';
            return smiles
                .replace(/\s+/g, '')
                .replace(/\[H\]/g, '')
                .replace(/\[NH2\]/g, 'N')
                .replace(/\[NH\]/g, 'N')
                .replace(/\[OH\]/g, 'O')
                .replace(/\[SH\]/g, 'S')
                .replace(/\[O\]\[H\]/g, 'O');
        }

        function pickNewTarget() {
            const filtered = getFilteredAminoAcids();
            if (filtered.length === 0) {
                drawTarget = null;
                document.getElementById('draw-target-name').textContent = 'No Match';
                document.getElementById('draw-feedback').textContent = 'No amino acids match this filter.';
                return;
            }
            drawTarget = filtered[Math.floor(Math.random() * filtered.length)];
            document.getElementById('draw-target-name').textContent = drawTarget.name;
            document.getElementById('draw-feedback').textContent = 'Draw the structure, then check your answer.';
            document.getElementById('draw-user-smiles').textContent = '-';
            document.getElementById('draw-expected-smiles').textContent = '-';
            if (jsmeApplet) {
                jsmeApplet.reset();
            }
            updateExpectedStructure();
        }

        function updateExpectedStructure() {
            if (!drawTarget) return;
            const SmiDrawer = window.SmiDrawer || SmilesDrawer.SmiDrawer;
            const smilesDrawer = new SmiDrawer({ ...mainStrategy, width: 600, height: 420, bondThickness: 2.6 });
            smilesDrawer.draw(drawTarget.smiles, '#draw-expected-canvas', isDarkMode ? 'dark' : 'light');
        }

        function checkAnswer() {
            if (!drawTarget || !jsmeApplet) return;
            const userSmiles = jsmeApplet.smiles();
            const expectedSmiles = drawTarget.smiles;
            document.getElementById('draw-user-smiles').textContent = userSmiles || 'No structure drawn.';
            document.getElementById('draw-expected-smiles').textContent = expectedSmiles;

            const isCorrect = normalizeSmiles(userSmiles) === normalizeSmiles(expectedSmiles);
            const feedback = document.getElementById('draw-feedback');
            if (isCorrect && userSmiles) {
                feedback.textContent = 'Correct structure!';
                feedback.className = 'text-lg font-bold text-emerald-600';
            } else {
                feedback.textContent = 'Not quite. Compare your structure with the expected one.';
                feedback.className = 'text-lg font-bold text-amber-600';
            }
        }

        function clearDrawing() {
            if (jsmeApplet) {
                jsmeApplet.reset();
            }
            document.getElementById('draw-user-smiles').textContent = '-';
            document.getElementById('draw-feedback').textContent = 'Draw the structure, then check your answer.';
            document.getElementById('draw-feedback').className = 'text-lg font-bold text-slate-600';
        }

        window.addEventListener('load', () => {
            pickNewTarget();
            document.getElementById('check-answer-btn').addEventListener('click', checkAnswer);
            document.getElementById('new-target-btn').addEventListener('click', pickNewTarget);
            document.getElementById('clear-drawing-btn').addEventListener('click', clearDrawing);
        });

        window.addEventListener('themeChanged', () => {
            updateExpectedStructure();
        });

        window.addEventListener('filterChanged', () => {
            pickNewTarget();
        });
    </script>
</body>
</html>
